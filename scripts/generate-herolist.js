const fs = require('fs');
const path = require('path');
const https = require('https');

/**
 * æ•°æ®æºï¼šè…¾è®¯å®˜æ–¹è‹±é›„è”ç›Ÿ CDN æ ¸å¿ƒæ•°æ®
 * åŒ…å«ï¼šè‹±æ–‡å(alias), ä¸­æ–‡ç§°å·(name), ä¸­æ–‡å(title), è§’è‰²æ ‡ç­¾(roles)
 */
const DATA_SOURCE_URL = 'https://game.gtimg.cn/images/lol/act/img/js/heroList/hero_list.js';
const OUTPUT_FILE = path.join(__dirname, 'herolist.ts');

/**
 * ID è§„èŒƒåŒ–
 * ç¡®ä¿ç”Ÿæˆçš„ id ä¸æœ¬åœ°å›¾ç‰‡æ–‡ä»¶åï¼ˆå°å†™è‹±æ–‡ aliasï¼‰å®Œå…¨åŒ¹é…ã€‚
 */
const ID_FIXES = {
  'MonkeyKing': 'monkeyking',
  'Renata': 'renata',
  'Nunu': 'nunu',
  'LeBlanc': 'leblanc',
  'KogMaw': 'kogmaw',
  'RekSai': 'reksai',
  'BelVeth': 'belveth',
  'Kaisa': 'kaisa',
  'Khazix': 'khazix'
};

/**
 * æŠ“å–å‡½æ•°
 */
const fetchRawContent = (url) => {
  return new Promise((resolve, reject) => {
    const options = {
      headers: {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Referer': 'https://lol.qq.com/'
      }
    };
    https.get(url, options, (res) => {
      if (res.statusCode !== 200) {
        return reject(new Error(`æ— æ³•è®¿é—®ç½‘é¡µ: ${res.statusCode} (URL: ${url})`));
      }
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => resolve(data));
    }).on('error', reject);
  });
};

/**
 * åˆ†è·¯è‡ªåŠ¨æ¨æ–­é€»è¾‘ (åŸºäºå®˜æ–¹èŒä¸šæ ‡ç­¾)
 */
const autoAssignRoles = (hero) => {
  const roles = new Set();
  const tags = hero.roles || [];
  const alias = hero.alias.toLowerCase();

  // 1. åŸºç¡€æ˜ å°„
  if (tags.includes('tank') || tags.includes('fighter')) roles.add('TOP');
  if (tags.includes('mage') || tags.includes('assassin')) roles.add('MID');
  if (tags.includes('marksman')) roles.add('BOT');
  if (tags.includes('support')) roles.add('SUP');

  // 2. è‡ªåŠ¨åŒ–æ‰“é‡è¯†åˆ« (å…³é”®è¯)
  const jungleKeys = ['vi', 'viego', 'lee', 'khazix', 'rengar', 'hecarim', 'shaco', 'nidalee', 'elise', 'ivern', 'belveth', 'briar', 'skarner', 'rammus', 'warwick', 'kindred', 'lillia', 'nunu', 'amumu', 'volibear', 'udyr', 'trundle', 'evelynn', 'graves', 'gragas', 'jarvan', 'xin', 'masteryi', 'fiddlesticks', 'sejuani', 'zac', 'nocturne'];
  if (jungleKeys.some(k => alias.includes(k))) roles.add('JG');

  // 3. ç‰¹æ®Šé€»è¾‘ä¿®æ­£
  if (tags.includes('marksman') && !tags.includes('mage') && !tags.includes('fighter')) {
    roles.delete('MID');
    roles.add('BOT');
  }
  if (tags.includes('support') && (tags.includes('mage') || tags.includes('tank'))) {
    roles.delete('TOP');
    roles.delete('MID');
    roles.add('SUP');
  }

  const finalRoles = Array.from(roles);
  return finalRoles.length > 0 ? finalRoles : ['MID'];
};

const run = async () => {
  console.log('ğŸš€ æ­£åœ¨ä»è…¾è®¯å®˜æ–¹ CDN æŠ“å–å…¨é‡è‹±é›„æ•°æ®ï¼ˆå«ä¸­æ–‡å†…å®¹ï¼‰...');

  try {
    const rawContent = await fetchRawContent(DATA_SOURCE_URL);
    
    // è§£æ JSON
    const data = JSON.parse(rawContent);
    const champions = data.hero || [];
    
    if (champions.length === 0) {
      throw new Error('æŠ“å–åˆ°çš„è‹±é›„åˆ—è¡¨ä¸ºç©ºã€‚');
    }

    console.log(`æˆåŠŸè·å–åˆ° ${champions.length} ä½è‹±é›„çš„åŸå§‹è®°å½•ã€‚`);

    // è¿‡æ»¤å¹¶å¤„ç†è‹±é›„æ•°æ®
    const heroList = champions
      .filter(c => c.alias && c.alias !== 'None')
      .sort((a, b) => a.alias.localeCompare(b.alias))
      .map(c => {
        const id = ID_FIXES[c.alias] || c.alias.toLowerCase();
        return {
          id,
          name: c.alias,       // è‹±æ–‡åˆ«å (Aatrox)
          nameCn: c.title,     // ä¸­æ–‡å (äºšæ‰˜å…‹æ–¯)
          titleCn: c.name,     // ä¸­æ–‡ç§°å· (æš—è£”å‰‘é­”)
          roles: autoAssignRoles(c)
        };
      });

    // ç”Ÿæˆ TS ä»£ç å†…å®¹
    const fileContent = `
/**
 * Auto-generated by scripts/generate-herolist.js
 * Source: Tencent LOL Official CDN (gtimg.cn)
 * Total Heroes: ${heroList.length}
 * Generated at: ${new Date().toLocaleString()}
 */

export interface Hero { 
  id: string; 
  name: string; 
  nameCn: string; 
  titleCn: string; 
  roles: string[]; 
}

export const RAW_HEROES: Hero[] = ${JSON.stringify(heroList, null, 2)};
`;

    fs.writeFileSync(OUTPUT_FILE, fileContent.trim());
    
    console.log('\nâœ¨ è‹±é›„åˆ—è¡¨ï¼ˆå«ä¸­æ–‡ï¼‰åŒæ­¥å®Œæˆï¼');
    console.log(`ä¿å­˜è·¯å¾„: ${OUTPUT_FILE}`);
    console.log('-------------------------------------------');
    console.log('ğŸ“Š åŒæ­¥è¯¦æƒ…:');
    console.log(`- è‹±é›„æ€»æ•°: ${heroList.length}`);
    console.log(`- ä¸­æ–‡æ”¯æŒ: âœ… å·²åŒæ­¥ (åŒ…å«ï¼šä¸­æ–‡åã€ç§°å·)`);
    console.log('-------------------------------------------');

  } catch (error) {
    console.error('âŒ æŠ“å–æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error.message);
  }
};

run();